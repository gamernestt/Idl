(function() {
  const targetDomain = "80-firebase-andrpid-2-1748354430437.cluster-w5vd22whf5gmav2vgkomwtc4go.cloudworkstations.dev";
  const key = "__autoBackEnabled";
  let isNavigating = false;

  function startLoop() {
    if (window.__autoBackInterval) {
      console.log("[AutoBack] Loop already running.");
      return;
    }

    console.log("[AutoBack] Starting 15s back loop...");
    window.__autoBackInterval = setInterval(async () => {
      if (isNavigating) return;
      
      try {
        // 1. Check if we're still in the target domain
        if (!location.hostname.includes(targetDomain)) {
          console.warn("[AutoBack] Left target domain, stopping");
          return stopLoop();
        }

        // 2. Check history (with fallback for browser inconsistencies)
        const canGoBack = history.length > 1 || 
                         performance.navigation.type === performance.navigation.TYPE_BACK_FORWARD;

        if (canGoBack) {
          console.log("[AutoBack] Navigating back...");
          isNavigating = true;
          
          // 3. Perform navigation with completion detection
          const beforeNav = performance.now();
          history.back();
          
          // 4. Wait for navigation to complete
          await new Promise(resolve => {
            const checkNav = () => {
              if (performance.now() - beforeNav > 500) { // 500ms timeout
                isNavigating = false;
                resolve();
              } else if (document.readyState === 'complete') {
                isNavigating = false;
                resolve();
              } else {
                setTimeout(checkNav, 50);
              }
            };
            checkNav();
          });
          
        } else {
          console.warn("[AutoBack] No more history");
          stopLoop();
        }
      } catch (e) {
        console.error("[AutoBack Error]", e);
        isNavigating = false;
      }
    }, 15000);
  }

  function stopLoop() {
    clearInterval(window.__autoBackInterval);
    delete window.__autoBackInterval;
    localStorage.removeItem(key);
    console.log("[AutoBack] Loop stopped.");
  }

  // Auto-start if enabled and in target domain
  if (location.hostname.includes(targetDomain)) {
    if (localStorage.getItem(key) === "true") {
      startLoop();
    } else if (confirm("Start auto-back every 15 seconds?")) {
      localStorage.setItem(key, "true");
      startLoop();
    }
  }

  window.stopAutoBack = stopLoop;
  window.startAutoBack = startLoop;
})();
