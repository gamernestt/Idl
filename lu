(function() {
  const targetURL = "https://80-firebase-andrpid-2-1748354430437.cluster-w5vd22whf5gmav2vgkomwtc4go.cloudworkstations.dev/vnc.html?autoconnect=true&resize=remote";
  const key = "__autoBackEnabled";

  function startLoop() {
    if (window.__autoBackInterval) {
      console.log("[AutoBack] Loop already running.");
      return;
    }

    console.log("[AutoBack] Starting 15s back loop...");
    window.__autoBackInterval = setInterval(() => {
      try {
        // Check if we can go back (history length > 1)
        if (history.length > 1) {
          console.log("[AutoBack] Navigating back...");
          history.back();
          
          // Add a small delay to ensure back navigation completes
          setTimeout(() => {
            // Check if we're still on a page that should continue the loop
            if (location.href.startsWith(targetURL.split('/')[0] + '//' + targetURL.split('/')[2])) {
              console.log("[AutoBack] Still in target domain, will continue looping");
            } else {
              console.warn("[AutoBack] Left target domain, stopping loop");
              stopLoop();
            }
          }, 1000);
        } else {
          console.warn("[AutoBack] No more history to go back to, stopping loop");
          stopLoop();
        }
      } catch (e) {
        console.error("[AutoBack Error]", e);
        stopLoop();
      }
    }, 15000);
  }

  function stopLoop() {
    if (window.__autoBackInterval) {
      clearInterval(window.__autoBackInterval);
      delete window.__autoBackInterval;
      localStorage.removeItem(key);
      console.log("[AutoBack] Loop stopped.");
    }
  }

  // Auto-start if enabled and on the right URL
  if (location.href.startsWith(targetURL.split('/')[0] + '//' + targetURL.split('/')[2])) {
    if (localStorage.getItem(key) === "true") {
      startLoop();
    } else {
      // Ask the user once
      const confirmed = confirm("Start auto-back every 15 seconds on this page?");
      if (confirmed) {
        localStorage.setItem(key, "true");
        startLoop();
      }
    }
  } else {
    console.warn("[AutoBack] Not on the target domain. Nothing started.");
  }

  // Expose control functions to console
  window.stopAutoBack = stopLoop;
  window.startAutoBack = startLoop;
})();
